{% extends "base.html" %}

{% block title %}{{ name }}{% endblock %}


{% block content %}

<div class="container">
  <div class="row">
    <div class="column">
      <h1>{{ name }}</h1>
    </div>
  </div>
</div>

{% raw %}
<div id="dashboard" class="container">
  <!-- Compartments -->

  <div class="row mt-5">
    <div class="col">
      <h2>Compartments</h2>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <table class="table">
        <thead>
          <tr>
            <th scope="col">Level</th>
            <th scope="col">Temperature</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="compartment in compartments" :key="compartment.clevel">
            <td>{{ compartment.clevel }}</td>
            <td>{{ compartment.temperature }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="row">
    <div class="col d-grid gap-2">
      <a class="btn btn-primary" href="/dashboard/add_compartment">Add Compartment</a>
    </div>
  </div>

  <!-- Markets -->

  <div class="row mt-5">
    <div class="col">
      <h2>Markets</h2>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <table class="table">
        <thead>
          <tr>
            <th scope="col">Name</th>
            <th scope="col">Location</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="market in markets" :key="market.mname">
            <td>{{ market.mname }}</td>
            <td>{{ market.location }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="row">
    <div class="col d-grid gap-2">
      <a class="btn btn-primary" href="/dashboard/add_market">Add Market</a>
    </div>
  </div>

  <!-- Items -->

  <div class="row mt-5">
    <div class="col">
      <h2>Items</h2>
    </div>
    <div class="col">
      Compartment
      <select class="form-select" v-model="searchedCompartment">
        <option value="-1">All</option>
        <option
          v-for="compartment in compartments"
          :key="compartment.clevel"
          :value="compartment.clevel"
        >
          {{ compartment.clevel }}
        </option>
      </select>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <table class="table">
        <thead>
          <tr>
            <th scope="col">Name</th>
            <th scope="col">Compartment</th>
            <th scope="col">Share</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="item in itemsInSearchedCompartment" :key="item.iid">
            <td scope="row">{{ item.name }}</td>
            <td>{{ item.clevel }}</td>
            <td>{{ item.share }}</td>
            <td>
              <a class="btn btn-secondary" :href="`/dashboard/edit_item?iid=${item.iid}`">Edit</a>
              <a class="btn btn-secondary" :href="`/dashboard/prepare_item?iid=${item.iid}`">Prepare</a>
              <a class="btn btn-secondary" :href="`/dashboard/share_item?item=${item.iid}&owner=${uid}`">Share</a>
              <a class="btn btn-secondary" :href="`/dashboard/move_item?item=${item.iid}&compartment=${item.clevel}`">Move</a>
              <a class="btn btn-secondary" :href="`/dashboard/nutrirent_item?iid=${item.iid}`">Nutrients</a>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="row">
    <div class="col d-grid gap-2">
      <a class="btn btn-primary" :href="`/dashboard/add_item/${uid}`">Add Item</a>
      <a class="btn btn-danger" :href="`/dashboard/remove/${uid}`">Remove Item</a>
    </div>
  </div>

  <!-- Preparation Methods -->

  <div class="row mt-5">
    <div class="col">
      <h2>Preparation Methods</h2>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <table class="table">
        <thead>
          <tr>
            <th scope="col">Name</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="method in methods" :key="method.method">
            <td>{{ method.method }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="row">
    <div class="col d-grid gap-2">
      <a class="btn btn-primary" href="/dashboard/add_preparation_method">Add Preparation Method</a>
    </div>
  </div>

   <!-- Nutrient -->

   <div class="row mt-5">
    <div class="col">
      <h2>Nutrients</h2>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <table class="table">
        <thead>
          <tr>
            <th scope="col">Name</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="nutrient in nutrients" :key="nutrient.nname">
            <td>{{ nutrient.nname }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="row">
    <div class="col d-grid gap-2">
      <a class="btn btn-primary" href="/dashboard/add_nutrient">Add Nutrient</a>
    </div>
  </div>

  <div class="row mt-2">
    <div class="col d-grid gap-2">
      <a class="btn btn-primary" href="/record">Record Consumption</a>
      <a class="btn btn-primary" href="/checkPay">Create Bill</a>
    </div>
  </div>
</div>
{% endraw %}
{% endblock %}

{% block scripts %}

  <script>
    const uid = Number.parseInt("{{ uid }}");
  </script>

  {% raw %}
    <script>
      new Vue({
        el: "#dashboard",
        data() {
          return {
            uid: uid,
            compartments: [],
            items: [],
            methods: [],
            markets: [],
            nutrients: [],
            searchedCompartment: -1
          }
        },
        computed: {
          itemsInSearchedCompartment() {
            if (this.searchedCompartment == -1) {
              return this.items;
            }

            console.log("filter");

            return this.items.filter(i => {
              console.log(this.searchedCompartment);
              console.log(i.clevel === this.searchedCompartment);
              return i.clevel === this.searchedCompartment
            });
          }
        },
        async mounted() {
          fetch(`/api/compartments`)
            .then(response => response.json())
            .then(compartments => {
              this.compartments = compartments
            });

          fetch(`/api/items/${uid}`)
            .then(response => response.json())
            .then(items => this.items = items);

          fetch(`/api/methods`)
            .then(response => response.json())
            .then(methods => this.methods = methods);

          fetch(`/api/markets`)
            .then(response => response.json())
            .then(markets => this.markets = markets);

          fetch(`/api/nutrients`)
            .then(response => response.json())
            .then(nutrients => this.nutrients = nutrients);
        }
      });
    </script>
  {% endraw %}
{% endblock %}
